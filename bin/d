#!/usr/bin/perl

=encoding UTF-8
=cut

=head1 DESCRIPTION

=cut

# common modules
use strict;
use warnings FATAL => 'all';
use feature 'say';
use utf8;
use open qw(:std :utf8);

use DDP; # TODO bes
use Carp;
use Class::Date qw(now date);
use Term::ANSIColor qw(colored);

# global vars
my $true = 1;
my $false = '';

my %ru_month_names = (
    1 => 'январь',
    2 => 'февраль',
    3 => 'март',
    4 => 'апрель',
    5 => 'май',
    6 => 'июнь',
    7 => 'июль',
    8 => 'август',
    9 => 'сентябрь',
    10 => 'октябрь',
    11 => 'ноябрь',
    12 => 'декабрь',
);

# subs
sub print_header {
    my @week = qw(Пн Вт Ср Чт Пт Сб Вс);
    print join(" ", @week) . "\n";
    return $false;
}

sub print_month {
    my (%opts) = @_;
    my $now = delete $opts{now};
    my $first_date = delete $opts{first_date};
    my $ident = delete $opts{ident};
    my $moment = date($first_date);

#    say $moment->monname() . " " . $moment->year();

    my $date_start = $moment->month_begin();
    my $date_end = $moment->month_end();

    my @week;

    my $date = $date_start;
    my $additional_text = '';

    while ($date <= $date_end) {
        my $day;

        $day->{number} = $date->day();

        $day->{color} = 'blue' if $day->{number} == 1;

        if (
            $now->year == $date->year
            && $now->month == $date->month
            && $now->day == $date->day
        ) {
            $day->{color} = 'red';
        }

        $date += '1D';

        if (($day->{number} == 1)) {
            push @week, '' foreach 1..$date->_wday()-1;
            $additional_text = ' 'x4 . $ru_month_names{$date->month()};
        }

        if (@week == 7) {
            print_week(@week);
            print $additional_text;
            $additional_text = '';
            say '';
            undef @week;
        }


        push @week, $day;
    }

    print_week(@week);
    say '';

    return $false;
}

sub print_week {
    my (@week) = @_;

    foreach (@week) {
        if (ref $_) {
            my $text = sprintf("%2d", $_->{number});

            if ($_->{color}) {
                print colored($text, $_->{color}) . " ";
            } else {
                print $text . " ";
            }
        } else {
            print " "x3;
        }
    }

#    foreach (@week) {
#        $_ = (" "x(2-length($_)) . $_) if length($_)<2
#    };

#    print join " ", @week;

    return $false;
}

# main
sub main {
    my $moment = now();
    say "";
    say " "x4 . $moment->strftime('%Y-%m-%d %H:%M:%S');
    say "";

    print_header();
    print_month( first_date => "2013-11-01", now => $moment, ident => $true );
    print_month( first_date => "2013-12-01", now => $moment, ident => $false );
    print_month( first_date => "2014-01-01", now => $moment, ident => $false );
    say "";
}

main();
__END__
